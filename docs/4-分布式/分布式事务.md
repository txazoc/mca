### 分布式事务

#### 分布式事务由来

> 微服务化和数据库拆分后，一个操作涉及多个服务、多个数据库

#### 两/三阶段提交协议(2PC/3PC)

#### TCC事务

#### 可靠消息

> 保证最终一致性

##### 本地消息表

* 服务A，本地事务写业务表和本地消息表
* 服务A，发送消息到MQ
* 服务B，幂等消费服务A的消息，处理完成后，通过RPC或MQ通知服务A更新本地消息表中消息状态
* 服务A，另启定时任务，定时扫描本地消息表中未完成的消息，重新投递到MQ

**缺点**

* 本地消息表和业务耦合，难以通用
* 本地消息表有性能瓶颈

##### RocketMQ分布式事务

> RocketMQ提供了事务消息支持分布式事务

* 同步发送Prepared消息到RocketMQ
* 消息发送失败，直接返回
* 消息发送成功，执行本地事务，存储消息id
* 本地事务执行失败，Rollback事务消息并删除
* 本地事务执行成功，Commit事务消息，RocketMQ开始投递消息
* 针对超时未确认的Prepared消息，RocketMQ会定时回查，最多回查15次
* 回查时，本地根据消息id查询本地事务状态，返回Rollback/Commit状态给RocketMQ

**消息消费**

* 消息消费时，通过RocketMQ的消费重试机制保证消息消费的可靠性，并做好幂等处理


[<< 上一篇: 分布式ID](4-分布式/分布式ID.md)
